# https://github.com/ofek/hatch-vcs/blob/master/.github/workflows/build.yml
name: build

on:
  push:
    tags:
    - v*
    branches:
        - main
        - "!dependabot/**"


concurrency:
  group: build-${{ github.head_ref }}

jobs:
  build:
    name: Build wheels and source distribution
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3

    - name: Install build dependencies
      run: python -m pip install --upgrade build

    - name: Build
      run: python -m build

    - uses: actions/upload-artifact@v3
      with:
        name: python-package-distributions
        path: dist/*
        if-no-files-found: error

  build-bin-manylinux-tested-arches:
    name: üë∑ manylinux${{ matrix.manylinux-year-target}}-${{ matrix.manylinux-image-target.arch}} üì¶ ${{ needs.pre-setup.outputs.git-tag }} for üêç ${{ matrix.manylinux-python-target }}
    needs:
        - build
    runs-on: ubuntu-latest
    strategy:
        matrix:
            manylinux-python-target:
                # NOTE: Must be from this list:
                # NOTE: $ podman run -it --rm \
                # NOTE:   quay.io/pypa/manylinux2014_x86_64 \
                # NOTE:   ls -1 /opt/python
                - cp36-cp36m
                - cp37-cp37m
                - cp38-cp38
                - cp39-cp39
                - cp310-cp310
                - cp311-cp311
                - cp312-cp312

    steps:
        - name: Switch to using Python 3.11 by default
          uses: actions/setup-python@v4.7.1
          with:
            python-version: 3.11
        - name: Retrieve the project source from an sdist inside the GHA artifact
          uses: re-actors/checkout-python-sdist@release/v1
          with:
            source-tarball-name: "*.tar.gz"
            workflow-artifact-name: python-package-distributions

  publish:
    name: Publish release
    needs:
    - build
    runs-on: ubuntu-latest

    steps:
    - uses: actions/download-artifact@v3
      with:
        name: artifacts
        path: dist

    - name: Push build artifacts to PyPI
      uses: pypa/gh-action-pypi-publish@v1.6.4
      with:
        skip_existing: true
        user: __token__
        password: ${{ secrets.PYPI_API_TOKEN }}